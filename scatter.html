<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v3.js"></script>
    <link href="hw2.css" type="text/css" rel="stylesheet" />
</head>

<body>

    <script>

        /* margin setup*/
        var margin = { top: 20, right: 20, bottom: 30, left: 80 };
        var width = 900 - margin.left - margin.right;
        var height = 1000 - margin.top - margin.bottom;

        var x = d3.scale.linear()
            .range([0, width]);

        var y = d3.scale.linear()
            .range([height, 0]);
        var color = d3.scale.category10();

        var xAxis = d3.svg.axis()
            .scale(x)
            .tickFormat(function (d) {
                console.log(d)
                return Math.round(d * 100) + "%";
            })
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .tickFormat(function (d) {
                console.log(d)
                return Math.round(d * 100) + "%";
            })
            .orient("left");

        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);


        /* Loading data */
        d3.csv("countries_of_world.csv", function (error, data) {

            if (error) throw error; //Error catching code.

            

            var selectionList = [
                { "text": "BirthRate" },
                { "text": "Population" },
                { "text": "Area" },
                { "text": "PopDensity" },
                { "text": "InfantMortality" },
                { "text": "GDP" },
                { "text": "LiteracyRate" },
                { "text": "ArableLand" },
                { "text": "CropsLand" },
                { "text": "OtherLand" },
                { "text": "DeathRate" },
                { "text": "Agriculture" },
                { "text": "Industry" },
                { "text": "Service" },
            ]

            var selectionListY = [
                { "text": "DeathRate" },
                { "text": "BirthRate" },
                { "text": "Population" },
                { "text": "Area" },
                { "text": "PopDensity" },
                { "text": "InfantMortality" },
                { "text": "GDP" },
                { "text": "LiteracyRate" },
                { "text": "ArableLand" },
                { "text": "CropsLand" },
                { "text": "OtherLand" },
                { "text": "Agriculture" },
                { "text": "Industry" },
                { "text": "Service" },
            ]

            var body = d3.select("body");

            //Create x selection list
            var span = body.append("span")
                .text("Select X-Axis variable; ")
            var xOption = body.append("select")
                .attr("id", "xSelect")
                .on('change', xChange)
                .selectAll('option')
                .data(selectionList)
                .enter()
                .append("option")
                .attr("value", function (d) {
                    return d.text;
                })
                .text(function (d) {
                    return d.text;
                })
            body.append('br')


            //Create y selection list
            var span = body.append("span")
                .text("Select Y-Axis variable; ")
            var yOption = body.append("select")
                .attr("id", "ySelect")
                .on('change', yChange)
                .selectAll('option')
                .data(selectionListY)
                .enter()
                .append("option")
                .attr("value", function (d) {
                    return d.text;
                })
                .text(function (d) {
                    return d.text;
                })
            body.append('br')

            data.forEach(function (d) {
                d['birthRate'] = d["Birth Rate"]; // parsing header field with space in the middle
                d['deathRate'] = d["Death Rate"];
                d['PopDensity'] = d["Pop. Density (per sq. mi.)"];
                d['InfantMortality'] = d["Infant mortality"];
                d['GDP'] = d["GDP (per capita)"];
                d['LiteracyRate'] = d["Literacy Rate"];
                d['ArableLand'] = d["Arable land (%)"];
                d['CropsLand'] = d["Crops land (%)"];
                d['OtherLand'] = d["Other land (%)"];
                d['BirthRate'] = d["Birth Rate"];
                d['DeathRate'] = d["Death Rate"];


            });

            x.domain([0, d3.max(data, function (d) {
                return d.birthRate;
            })]).nice();

            y.domain([0, d3.max(data, function (d) {
                return d.deathRate;
            })]).nice();



            var zoomBeh = d3.behavior.zoom()
                            .x(x)
                            .y(y)
                            .scaleExtent([0,50])
                            .on("zoom",zoom);

            /* Append a canvas (svg element) */
            var svgSelection = d3.select("body")
                .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .call(zoomBeh)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            

            var gXAxis = svgSelection.append("g")
                                    .attr("class", "axis")
                                    .attr("id", "xAxis")
                                    .attr("transform", "translate(0," + height + ")")
                                    .call(xAxis)
                                    .append("text")
                                    .attr("class", "label")
                                    .attr('id', 'xAxisLabel')
                                    .attr("x", width)
                                    .attr("y", -6)
                                    .style("text-anchor", "end")
                                    .text("Birth Rate%");

            var gYAxis = svgSelection.append("g")
                                    .attr("class", "axis")
                                    .attr("id", "yAxis")
                                    .call(yAxis)
                                    .append("text")
                                    .attr("class", "label")
                                    .attr('id', 'yAxisLabel')
                                    .attr("transform", "rotate(-90)")
                                    .attr("y", 6)
                                    .attr("dy", ".71em")
                                    .style("text-anchor", "end")
                                    .text("Death Rate%");
            

            var xMemory = 'birthRate';

            var yMemory = 'deathRate'; 
            

            // Actually insert scatter points
            svgSelection.selectAll(".dot")
                .data(data)
                .enter()
                .append("circle")
                .attr("class", "dot")
                .attr("r", 4)
                .attr("cx", function (d) {
                    return x(d.birthRate);
                })
                .attr("cy", function (d) {
                    return y(d.deathRate);
                })
                //.attr("transform",transform)
                .style("fill", function (d) {
                    return color(d.Region);
                })
                .style("stroke", "black")
                .on("mouseover", function (d) {
                    d3.select(this)
                      .transition()
                      .duration(200)
                      .attr('r',20)
                      .attr('stroke-width',3)
                    div.transition()
                        .duration(500)
                        .style("opacity", .9);
                    div.html(d.Country)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px")
                })
                .on("click", function () {
                    d3.select(this)
                        .remove();
                })
                .on("mouseout", function (d) {
                    d3.select(this)
                      .transition()
                      .duration(200)
                      .attr('r', 4)
                      .attr("stroke-width", 1);
                    div.transition()
                        .duration(50)
                        .style("opacity", 0)
                });

            var legend = svgSelection.selectAll(".legend")
                .data(color.domain())
                .enter()
                .append("g")
                .attr("class", "legend")
                .attr("transform", function (d, i) {
                    return "translate(0," + i * 20 + ")";
                });

            legend.append("rect")
                .attr("x", width - 18)
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", color);

            legend.append("text")
                .attr("x", width - 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .style("text-anchor", "end")
                .text(function (d) {
                    return d;
                });


            function yChange() {
                var value = this.value; //get new y axis value
                yMemory = value;
                y.domain([
                    d3.min([0, d3.min(data, function (d) {
                        return parseFloat(d[value]);
                    })]),
                    d3.max([0, d3.max(data, function (d) {
                        return parseFloat(d[value]);
                    })])
                ])

                yAxis.scale(y)
                     .tickFormat(function(d){
                        if (value.includes('Rate')) {
                            return d3.format(".2f")(d*100)+"%";
                        } 
                        else if (value.includes('mortality')) {
                            return d3.format(".2f")(d*100)+"%";
                        }
                        else if (value.includes("Land")){
                            return d3.format(".2f")(d) + "%";
                        }
                        else {
                            return d;
                        }
                     });
                d3.select('#yAxis')
                    .transition().duration(1000)
                    .call(yAxis)
                d3.select('#yAxisLabel')
                    .text(value)
                d3.selectAll("circle")
                    .transition().duration(1000)
                    .delay(function (d, i) {
                        return i * 10;
                    })
                    .attr('cy', function (d) {
                        return y(d[value])
                    })
            };

            function xChange() {
                var value = this.value; //get new x axis value
                xMemory = value;
                x.domain([
                    d3.min([0, d3.min(data, function (d) {
                        return parseFloat(d[value]);
                    })]),
                    d3.max([0, d3.max(data, function (d) {
                        return parseFloat(d[value]);
                    })])
                ])

                xAxis.scale(x)
                     .tickFormat(function(d){
                        if (value.includes('Rate')) {
                            return d3.format(".2f")(d*100)+"%";
                        } 
                        else if (value.includes('mortality')) {
                            return d3.format(".2f")(d*100)+"%";
                        }
                        else if (value.includes("Land")){
                            return d3.format(".2f")(d) + "%";
                        }
                        else {
                            return d;
                        }
                     });
                
                d3.select('#xAxis')
                    .transition().duration(1000)
                    .call(xAxis)
                d3.select('#xAxisLabel')
                    .text(value)
                d3.selectAll("circle")
                    .transition().duration(1000)
                    .delay(function (d, i) {
                        return i * 10;
                    })
                    .attr('cx', function (d) {
                        return x(d[value])
                    })
            };

            function zoom() {
                var value = this.value;
                console.log("zoom triggered");
                svgSelection.select("#xAxis").call(xAxis);
                svgSelection.select("#yAxis").call(yAxis);

                svgSelection.selectAll(".dot")
                   .attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
            }

            function transform(d) {
                var value = this.value;
            }
        });
    </script>

    <script>
        function showMessage() {
            alert("You made a terrible choice!")
        }



    </script>

</body>

</html>